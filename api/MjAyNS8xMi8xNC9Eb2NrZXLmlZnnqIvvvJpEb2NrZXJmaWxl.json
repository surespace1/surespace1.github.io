{"title":"Docker教程：Dockerfile","date":"2025-12-14T04:17:34.000Z","date_formatted":{"ll":"2025年12月14日","L":"2025/12/14","MM-DD":"12-14"},"link":"2025/12/14/Docker教程：Dockerfile","comments":true,"tags":["docker"],"categories":["开发"],"updated":"2025-12-14T04:19:22.177Z","content":"<blockquote>\n<p>Dockerfile 是一个用于将本地项目打包为 Docker 镜像的文本配置文件，它包含了一系列指令，告诉 Docker 如何构建镜像。</p>\n</blockquote>\n<span id=\"more\"></span>\n<p><strong>核心机制：分层构建与缓存</strong></p>\n<p>在 Dockerfile 中，每一个指令（如 <code>RUN</code>, <code>COPY</code>）都会创建一个新的镜像层。</p>\n<p>Docker 的缓存机制：如果某一层及其之前的层没有发生变化，在下次构建时，Docker 会直接使用缓存，从而极大地加快构建速度。</p>\n<h2 id=\"一、-常用指令\">一、 常用指令<a title=\"#一、-常用指令\" href=\"#一、-常用指令\"></a></h2>\n<ol>\n<li>基础与元数据</li>\n</ol>\n<p><code>FROM</code></p>\n<ul>\n<li>\n<p>作用：指定基础镜像。</p>\n</li>\n<li>\n<p>注意：必须是 Dockerfile 的非注释第一行。建议明确指定版本号（Tag），如 <code>python:3.10-slim</code>，避免使用不稳定的 <code>latest</code>。</p>\n</li>\n</ul>\n<p><code>WORKDIR</code></p>\n<ul>\n<li>\n<p>作用：设置容器内的工作目录。</p>\n</li>\n<li>\n<p>注意：如果目录不存在会自动创建。后续的 <code>RUN</code>, <code>CMD</code>, <code>ENTRYPOINT</code>, <code>COPY</code> 指令都会基于此目录执行。</p>\n</li>\n</ul>\n<p><code>LABEL</code></p>\n<ul>\n<li>\n<p>作用：为镜像添加元数据（如作者、版本、描述）。</p>\n</li>\n<li>\n<p>示例：<code>LABEL maintainer=&quot;user@example.com&quot;</code>。</p>\n</li>\n</ul>\n<ol start=\"2\">\n<li>文件操作</li>\n</ol>\n<p><code>COPY</code></p>\n<ul>\n<li>\n<p>作用：将本地文件复制到容器中。</p>\n</li>\n<li>\n<p>推荐：大多数情况下优先使用 <code>COPY</code>。</p>\n</li>\n<li>\n<p>示例：<code>COPY requirements.txt .</code></p>\n</li>\n</ul>\n<p><code>ADD</code></p>\n<ul>\n<li>\n<p>作用：高级复制功能。除了复制本地文件，还支持从 URL 下载文件，以及自动解压 tar/gzip 压缩包。</p>\n</li>\n<li>\n<p>注意：除非需要自动解压，否则不建议使用。</p>\n</li>\n</ul>\n<ol start=\"3\">\n<li>环境与变量</li>\n</ol>\n<p><code>ENV</code></p>\n<ul>\n<li>\n<p>作用：设置环境变量。</p>\n</li>\n<li>\n<p>生命周期：构建期和运行期均有效。在容器运行时，应用可以通过读取环境变量获取这些值。</p>\n</li>\n</ul>\n<p><code>ARG</code></p>\n<ul>\n<li>\n<p>作用：设置构建参数。</p>\n</li>\n<li>\n<p>生命周期：仅在构建镜像时有效，容器运行时不会保留。常用于传递版本号等构建时需要的临时参数。</p>\n</li>\n</ul>\n<ol start=\"4\">\n<li>执行命令</li>\n</ol>\n<p><code>RUN</code></p>\n<ul>\n<li>\n<p>作用：在构建镜像时执行的 Shell 命令（如安装软件、创建文件夹）。</p>\n</li>\n<li>\n<p>技巧：建议使用 <code>&amp;&amp;</code> 连接多个命令，并使用 <code>\\</code> 换行。这可以将多个操作合并为一个镜像层，减少镜像体积。</p>\n</li>\n</ul>\n<p><code>CMD</code></p>\n<ul>\n<li>\n<p>作用：容器启动时默认执行的命令。</p>\n</li>\n<li>\n<p>覆盖性：如果在运行容器（<code>docker run</code>）时指定了其他命令，<code>CMD</code> 指定的命令会被覆盖。</p>\n</li>\n</ul>\n<p><code>ENTRYPOINT</code></p>\n<p>作用：容器启动时的入口点。</p>\n<p>追加性：<code>docker run</code> 后面的参数会被追加到 <code>ENTRYPOINT</code> 指令的后面，而不会覆盖它。常用于将容器当作一个可执行程序使用。</p>\n<ol start=\"5\">\n<li>网络与存储</li>\n</ol>\n<p><code>EXPOSE</code></p>\n<ul>\n<li>\n<p>作用：声明容器打算监听的端口。</p>\n</li>\n<li>\n<p>注意：这只是一个“声明”，不会自动将端口映射到宿主机。运行时仍需使用 <code>-p</code> 参数进行映射。</p>\n</li>\n</ul>\n<p><code>VOLUME</code></p>\n<ul>\n<li>\n<p>作用：定义匿名数据卷。</p>\n</li>\n<li>\n<p>目的：用于持久化数据，防止容器删除后数据丢失。</p>\n</li>\n</ul>\n<h2 id=\"二、-实战示例：构建-pytorch-+-fastapi-镜像\">二、 实战示例：构建 PyTorch + FastAPI 镜像<a title=\"#二、-实战示例：构建-pytorch-+-fastapi-镜像\" href=\"#二、-实战示例：构建-pytorch-+-fastapi-镜像\"></a></h2>\n<p>以下是一个生产级别的 Dockerfile 示例，包含 Python 环境配置、系统依赖安装、PyTorch 安装及应用启动。</p>\n<p>优化策略：</p>\n<ol>\n<li>利用缓存：先复制 <code>requirements.txt</code> 并安装依赖，再复制源代码。这样只要依赖不变，代码修改后构建极快。</li>\n<li>清理垃圾：在 <code>apt-get</code> 后立即清理缓存，减小镜像体积。</li>\n</ol>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 指定基础镜像</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> python:<span class=\"number\">3.10</span>-slim</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置环境变量</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PYTHONDONTWRITEBYTECODE=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PYTHONUNBUFFERED=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置工作目录</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装系统依赖 (合并命令以减少镜像层)</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apt-get update &amp;&amp; apt-get install -y \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    libgl1 \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    libglib2.0-0 \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    curl \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    git \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    cmake \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    build-essential \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    fonts-noto-cjk \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    fontconfig \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; <span class=\"built_in\">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 优先安装 Python 依赖</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> requirements.txt .</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装普通依赖</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pip install --no-cache-dir -r requirements.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 单独安装 PyTorch (因为体积大且变动少，单独一层便于缓存)</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pip install --no-cache-dir \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    torch==2.5.1+cu124 torchvision torchaudio \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    --index-url https://download.pytorch.org/whl/cu124</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装其他特定库</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pip install --no-cache-dir --upgrade <span class=\"string\">&quot;nvidia-cudnn-cu12==9.3.0.75&quot;</span></span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pip install --no-cache-dir -U typing_extensions</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 复制项目代码</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> . .</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 声明端口</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动命令</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;uvicorn&quot;</span>, <span class=\"string\">&quot;main:app&quot;</span>, <span class=\"string\">&quot;--host&quot;</span>, <span class=\"string\">&quot;0.0.0.0&quot;</span>, <span class=\"string\">&quot;--port&quot;</span>, <span class=\"string\">&quot;8000&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"三、-构建与运行\">三、 构建与运行<a title=\"#三、-构建与运行\" href=\"#三、-构建与运行\"></a></h2>\n<ol>\n<li>忽略文件 (.dockerignore)</li>\n</ol>\n<p>在构建之前，可以创建 <code>.dockerignore</code> 文件。类似 <code>.gitignore</code>，用于排除不需要打包进镜像的文件，能有效减小镜像体积并提高安全性。</p>\n<p><code>.dockerignore</code> 示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__pycache__</span><br><span class=\"line\">*.pyc</span><br><span class=\"line\">.git</span><br><span class=\"line\">.env</span><br><span class=\"line\">venv/</span><br><span class=\"line\">.DS_Store</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>构建镜像 (Build)</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t fastapi-app:v1 .</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>-t</code>：标记镜像名称和标签（Name:Tag）。</li>\n<li><code>.</code>：指定构建上下文（Context）为当前目录。Docker 会将该目录下的所有文件（排除 <code>.dockerignore</code> 里的）发送给 Docker 引擎。</li>\n</ul>\n<ol start=\"3\">\n<li>运行容器 (Run)</li>\n</ol>\n<p>由于示例中包含了 CUDA/PyTorch，如果需要使用 GPU，运行时需添加 <code>--gpus</code> 参数。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d \\</span><br><span class=\"line\">  --name my-app-container \\</span><br><span class=\"line\">  --gpus all \\</span><br><span class=\"line\">  -p 8000:8000 \\</span><br><span class=\"line\">  -v $(<span class=\"built_in\">pwd</span>)/logs:/app/logs \\</span><br><span class=\"line\">  my-fastapi-app:v1</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>-d</code>：后台运行（Detached mode）。</li>\n<li><code>--gpus all</code>：允许容器访问宿主机的 GPU（需要宿主机安装 NVIDIA Container Toolkit）。</li>\n<li><code>-p 8000:8000</code>：端口映射（宿主机端口:容器端口）。</li>\n<li><code>-v</code>：挂载卷，将宿主机的 logs 目录挂载到容器内，用于日志持久化。</li>\n</ul>\n","next":{"title":"论文介绍:WebArena","link":"2025/12/09/论文介绍-WebArena"},"plink":"http://example.com/2025/12/14/Docker教程：Dockerfile/","toc":[{"id":"一、-常用指令","title":"一、 常用指令","index":"1"},{"id":"二、-实战示例：构建-pytorch-+-fastapi-镜像","title":"二、 实战示例：构建 PyTorch + FastAPI 镜像","index":"2"},{"id":"三、-构建与运行","title":"三、 构建与运行","index":"3"}],"reward":true,"copyright":{"custom":"copyright：自由转载-非商用-禁止演绎-保持署名（CC BY-NC-ND 4.0）"},"reading_time":"1315 words in 9 min"}